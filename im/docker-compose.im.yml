services:
  im-db:
    image: postgres:16
    container_name: terravoy-im-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-terravoy}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-terravoy_dev}
      POSTGRES_DB: ${POSTGRES_DB:-terravoy}
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - terravoy_im_pg:/var/lib/postgresql/data
      - ../db/migrations:/migrations:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB} -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  im-redis:
    image: redis:7
    container_name: terravoy-im-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: ["redis-server", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  im-api:
    build:
      context: ./im-api
      dockerfile: ./Dockerfile
      args:
        GOPROXY: ${GOPROXY:-https://goproxy.io,direct}
        GOSUMDB: ${GOSUMDB:-sum.golang.google.cn}
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        NO_PROXY: ${NO_PROXY:-}
    container_name: terravoy-im-api
    env_file:
      - ../.env
    depends_on:
      im-db:
        condition: service_healthy
      im-redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      IM_API_ADDR: :8090
      IM_DB_DSN: ${IM_DB_DSN:-postgres://terravoy:terravoy_dev@im-db:5432/terravoy?sslmode=disable}
      IM_REDIS_URL: ${IM_REDIS_URL:-redis://im-redis:6379/0}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET:-dev_auth_jwt_secret}
      NODE_ENV: production
      IM_RETENTION_MATCH_DAYS: ${IM_RETENTION_MATCH_DAYS:-14}
      IM_RETENTION_ORDER_DAYS: ${IM_RETENTION_ORDER_DAYS:-180}
    ports:
      - "${IM_API_PORT:-8090}:8090"

  im-worker:
    build:
      context: ./im-worker
      dockerfile: ./Dockerfile
      args:
        GOPROXY: ${GOPROXY:-https://goproxy.io,direct}
        GOSUMDB: ${GOSUMDB:-sum.golang.google.cn}
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        NO_PROXY: ${NO_PROXY:-}
    container_name: terravoy-im-worker
    depends_on:
      im-db:
        condition: service_healthy
      im-redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      IM_DB_DSN: ${IM_DB_DSN:-postgres://terravoy:terravoy_dev@im-db:5432/terravoy?sslmode=disable}
      IM_REDIS_URL: ${IM_REDIS_URL:-redis://im-redis:6379/0}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET:-dev_auth_jwt_secret}
      NODE_ENV: production
      IM_RETENTION_MATCH_DAYS: ${IM_RETENTION_MATCH_DAYS:-14}
      IM_RETENTION_ORDER_DAYS: ${IM_RETENTION_ORDER_DAYS:-180}
      FCM_SERVICE_ACCOUNT_JSON: ${FCM_SERVICE_ACCOUNT_JSON:-}
      FCM_SERVICE_ACCOUNT_PATH: ${FCM_SERVICE_ACCOUNT_PATH:-}
      PUSH_MAX_RETRIES: ${PUSH_MAX_RETRIES:-5}
      PUSH_RETRY_BACKOFF_MS: ${PUSH_RETRY_BACKOFF_MS:-1000}

  im-gateway:
    build:
      context: ../im-gateway
      dockerfile: ./Dockerfile
      args:
        GOPROXY: ${GOPROXY:-https://goproxy.io,direct}
        GOSUMDB: ${GOSUMDB:-sum.golang.google.cn}
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        NO_PROXY: ${NO_PROXY:-}
    container_name: terravoy-im-gateway
    depends_on:
      im-api:
        condition: service_started
      im-redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      IM_WS_ADDR: :8081
      IM_API_BASE_URL: ${IM_API_BASE_URL:-http://im-api:8090}
      REDIS_URL: ${IM_REDIS_URL:-redis://im-redis:6379/0}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET:-dev_auth_jwt_secret}
    ports:
      - "${IM_WS_PORT:-8081}:8081"

volumes:
  terravoy_im_pg:

# 使用主后端的网络，确保容器间可以通过 DNS 直接通信
networks:
  default:
    name: terravoy-backend_default
    external: true
